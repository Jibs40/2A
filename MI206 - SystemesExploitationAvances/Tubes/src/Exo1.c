#include <stdio.h>
#include <stdlib.h>

#include <unistd.h>
#include <sys/wait.h>
#include <sys/types.h>

#include "utils.h"

pid_t spawn_reader(int fds [], char *cmd[]){
    pid_t pid = fork();
    exit_if(pid==-1,"fork reader");
  if (pid==0){
    close(fds[1]);
    dup2(fds[0],0);
    execvp(cmd[0],cmd);
    exit_if(1,"exevp");
  }
    return pid;
}

pid_t spawn_writter(int fds [], char *cmd[]){
    pid_t pid = fork();
    exit_if(pid==-1,"fork writer");
    if (pid==0){
        close(fds[0]);
        dup2(fds[1],1);
        execvp(cmd[0],cmd);
        exit_if(1,"exevp");
    }
return pid;
}


void print_cmd(const char *prefix, char *cmd[])
{
    fprintf(stdout, "%s:", prefix);
    while (*cmd)
        fprintf(stdout, "%s", *cmd++);
    fputs("\n", stdout);
}

int main(int argc, char *argv[])
{
    int status;

    char *cmd1[argc];
    char *cmd2[argc];
    int tab_pipe[2];

    //exit_if(close(STDOUT_FILENO) == -1, "close");                            // Prend valeur 0 : Cette ligne ferme entree standard

    exit_if(split_args(argv + 1, cmd1, cmd2) == -1,
            "Syntaxe: mypipe cmd1 [args] -- cmd2 [args]");

    print_cmd("cmd1", cmd1);
    print_cmd("cmd2", cmd2);

    int spawn_read_res = spawn_reader(tab_pipe,cmd2);
    int spawn_write_res = spawn_writter(tab_pipe,cmd1);
    int mypipe = pipe(tab_pipe);

    exit_if(mypipe == -1, "error pipe");

    close(tab_pipe[0]);
    close(tab_pipe[1]);

    int wait_res1 = wait(&status);
    int wait_res2 = wait(&status);

    return EXIT_SUCCESS;
}