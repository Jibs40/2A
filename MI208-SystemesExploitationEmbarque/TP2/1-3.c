#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/resource.h>
#include <sched.h>
#include <signal.h>
#include <time.h>
#include <unistd.h>

#define BUFFERLENGTH 100
char tmp[BUFFERLENGTH];
static FILE *src = NULL;

// MI208 SANCHEZ_DIRIS // TP2 - ORDONNANCEMENT /!\ LANCER LE PROGRAMME EN SUPERUTILISATEUR /!\

int main(int argc, char *argv[]){

// Dossier contenant les informations relatives à la priorité du processus en cours d'exécution
FILE *src = fopen("/proc/self/sched","r");
// Test Appel système
if (src == NULL){
	fprintf(stderr, "OPEN");
	exit(EXIT_FAILURE);
}
printf("__________________Q1________________\n");

// PID du processus en cours
int pid = getpid();
printf("PID : \t\t\t\t%d\n", pid);

//Q1
// Verification priorité avec appel système
int prio = 0;
	if (prio= getpriority(PRIO_PROCESS,pid) == -1){
		fprintf(stderr, "PRIO Q1");
		exit(EXIT_FAILURE);
	}
	else
		printf("Priorite avec getprio : \t%d\n",prio);
	
// Vérification priorité dans le dossier "self"
// Différente de la priorité précédente car exprimé dans une base différente

while ( fgets(tmp, BUFFERLENGTH, src) != NULL ){
    if (strstr(tmp,"prio") != NULL){
    printf("Prio repertoire self: \t%s",tmp);
    }
}
//Q2 Modification de la priorité du processus en cours
int setprio = 0;
int getprio = 0;
int ValeurPrioModifiee = -10;
printf("__________________Q2________________\n");
printf("Nouvelle valeur prio: \t\t%d\n",ValeurPrioModifiee);

if (setprio = setpriority(PRIO_PROCESS,pid,ValeurPrioModifiee) == -1){
	fprintf(stderr, "SET PRIO Q2");
	exit(EXIT_FAILURE);
	}

getprio = getpriority(PRIO_PROCESS,pid);
printf("GetPrio apres changement: \t%d\n",getprio);

//Q3 Modification de la politique : PROCESS TEMPS REEL /!\ LANCER AVEC SUDO /!\

printf("__________________Q3________________\n");

// Pour modifier la politique de priorité
struct sched_param p;
// Pour stocker la valeur retour de get_param()
struct sched_param resultStruct;
// On prend la priorite maximale de la politique FIFO
p.sched_priority = sched_get_priority_max(SCHED_FIFO); 
printf("Nouvelle valeur Temps Reel : \t%d\n",p.sched_priority);

// Passage en processus temps reel, politique FIFO
int setcheduler = 0;
if (setcheduler = sched_setscheduler(pid,SCHED_FIFO,&p) != 0){
	fprintf(stderr, "SET SCHEDULER Q3");
	exit(EXIT_FAILURE);
	}


int getparam = 0;
if (getparam = sched_getparam(pid,&resultStruct) != 0){
	fprintf(stderr, "GETPARAM Q3");
	exit(EXIT_FAILURE);
	}

printf("Prio temps reel: \t\t%d\n",resultStruct.sched_priority);

return EXIT_SUCCESS;
}