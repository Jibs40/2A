#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define LED0 "/sys/class/leds/beaglebone:green:heartbeat"
#define LED1 "/sys/class/leds/beaglebone:green:mmc0"
#define LED2 "/sys/class/leds/beaglebone:green:usr2"
#define LED3 "/sys/class/leds/beaglebone:green:usr3"

static int sommeil              = 0;
static int NbAllersRetours      = 0;

void LED0_EcrireFichier(char NomFichier[], char Valeur[]){
    FILE* ptrFile;                                         // Pointeur de fichier ptrFile
    char Fichier[80];                                      // Chaine de caractere pour stocker le nom du fichier et son chemin
    sprintf(Fichier, LED0 "%s", NomFichier);               // Reconstitution du chemin et du nom du fichier
    ptrFile = fopen(Fichier, "w+");                        // Ouverture du fichier en écriture
    fprintf(ptrFile, "%s", Valeur);                        // Envoi de la valeur dans le fichier
    fclose(ptrFile);                                       // Fermeture du fichier
}

void LED1_EcrireFichier(char NomFichier[], char Valeur[]){
    FILE* ptrFile1; 
    char Fichier1[80]; 
    sprintf(Fichier1, LED1 "%s", NomFichier); 
    ptrFile1 = fopen(Fichier1, "w+"); 
    fprintf(ptrFile1, "%s", Valeur); 
    fclose(ptrFile1);
}

void LED2_EcrireFichier(char NomFichier[], char Valeur[]){
    FILE* ptrFile2; 
    char Fichier2[80]; 
    sprintf(Fichier2, LED2 "%s", NomFichier); 
    ptrFile2 = fopen(Fichier2, "w+"); 
    fprintf(ptrFile2, "%s", Valeur); 
    fclose(ptrFile2);
}

void LED3_EcrireFichier(char NomFichier[], char Valeur[]){
    FILE* ptrFile3; 
    char Fichier3[80]; 
    sprintf(Fichier3, LED3 "%s", NomFichier);
    ptrFile3 = fopen(Fichier3, "w+"); 
    fprintf(ptrFile3, "%s", Valeur); 
    fclose(ptrFile3); 
}

void RAZ(){
    // RAZ des triggers
    LED0_EcrireFichier("/trigger", "none"); 
    LED1_EcrireFichier("/trigger", "none"); 
    LED2_EcrireFichier("/trigger", "none"); 
    LED3_EcrireFichier("/trigger", "none"); 

    //  Extinction des leds
    LED0_EcrireFichier("/brightness", "0"); 
    LED1_EcrireFichier("/brightness", "0"); 
    LED2_EcrireFichier("/brightness", "0"); 
    LED3_EcrireFichier("/brightness", "0"); 
}

void Aller(){
    LED0_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED0_EcrireFichier("/brightness", "0"); // Extinction de la LED

    LED1_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED1_EcrireFichier("/brightness", "0"); // Extinction de la LED

    LED2_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED2_EcrireFichier("/brightness", "0"); // Extinction de la LED

    LED3_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED3_EcrireFichier("/brightness", "0"); // Extinction de la LED
}


void Retour(){
    LED3_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED3_EcrireFichier("/brightness", "0"); // Extinction de la LED

    LED2_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED2_EcrireFichier("/brightness", "0"); // Extinction de la LED 

    LED1_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED1_EcrireFichier("/brightness", "0"); // Extinction de la LED

    LED0_EcrireFichier("/brightness", "1"); // Allumage de la LED
    usleep(sommeil);
    LED0_EcrireFichier("/brightness", "0"); // Extinction de la LED
}

void AllerRetour(){
    Aller();
    Retour();
}

int main(int argc, char* argv[]){

    if ((argc != 3) || (sscanf(argv[1], "%d", & sommeil) != 1) || (sscanf(argv[2], "%d", & NbAllersRetours) != 1) ){
        fprintf(stderr, "usage: %s <Frequence_en_us(Recommande:400000)> <NbAllersRetours>\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    printf("RAZ de la politique des Leds\n");
    RAZ();

    printf("C'est parti pour K2000!\n");
    Aller();
    AllerRetour();

    printf("Debut des allers-retours\n");
    for (int i = 1; i<=NbAllersRetours; i++){
        AllerRetour();
    }

    RAZ();
    printf("C'est déjà la fin :'(\n");

return 0;
}